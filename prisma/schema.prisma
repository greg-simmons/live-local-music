generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== Enums =====
enum UserRole {
  admin
  artist
  venue
}

// ===== User =====
model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  role         UserRole
  isVerified   Boolean   @default(false) @map("is_verified")
  createdAt    DateTime  @default(now()) @map("created_at")
  lastLogin    DateTime? @map("last_login")

  // one-to-one to artist
  artistId String? @unique @map("artist_id")
  artist   Artist? @relation("UserArtist", fields: [artistId], references: [id], onDelete: Restrict)

  // one-to-one to venue
  venueId String? @unique @map("venue_id")
  venue   Venue?  @relation("UserVenue", fields: [venueId], references: [id], onDelete: Restrict)

  // events created by this user
  createdEvents   Event[]          @relation("EventCreator")
  favoriteArtists FavoriteArtist[]
  favoriteVenues  FavoriteVenue[]

  @@index([email])
  @@index([artistId])
  @@index([venueId])
  @@map("users")
}

// ===== Artist =====
model Artist {
  id              String    @id @default(cuid())
  name            String    @db.VarChar(200)
  bio             String?   @db.Text
  zipCode         String?   @map("zip_code") @db.VarChar(10)
  contactName     String    @map("contact_name") @db.VarChar(100)
  contactPhone    String    @map("contact_phone") @db.VarChar(20)
  contactEmail    String    @map("contact_email") @db.VarChar(255)
  profileImageUrl String?   @map("profile_image_url") @db.VarChar(500)
  website         String?   @db.VarChar(500)
  socialLinks     Json?     @map("social_links")
  tipUrl          String?   @map("tip_url") @db.VarChar(500)
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // back to user
  user          User?            @relation("UserArtist")
  genres        ArtistGenre[]
  events        Event[]
  favoriteUsers FavoriteArtist[]

  @@index([isActive])
  @@index([zipCode])
  @@map("artists")
}

// ===== Venue =====
model Venue {
  id              String    @id @default(cuid())
  name            String    @db.VarChar(200)
  address         String    @db.VarChar(255)
  city            String    @db.VarChar(100)
  state           String    @db.VarChar(2)
  zipCode         String    @map("zip_code") @db.VarChar(10)
  latitude        Float
  longitude       Float
  contactName     String    @map("contact_name") @db.VarChar(100)
  contactPhone    String    @map("contact_phone") @db.VarChar(20)
  contactEmail    String    @map("contact_email") @db.VarChar(255)
  phone           String?   @db.VarChar(20)
  description     String?   @db.Text
  allowsSmoking   Boolean   @default(false) @map("allows_smoking")
  profileImageUrl String?   @map("profile_image_url") @db.VarChar(500)
  website         String?   @db.VarChar(500)
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // back to user
  user          User?           @relation("UserVenue")
  events        Event[]
  favoriteUsers FavoriteVenue[]

  @@index([latitude, longitude])
  @@index([isActive])
  @@map("venues")
}

// ===== Event =====
model Event {
  id          String  @id @default(cuid())
  title       String? @db.VarChar(200)
  description String? @db.Text

  // keep your separate date/time columns
  eventDate     DateTime  @map("event_date") @db.Date
  eventTime     DateTime  @map("event_time") @db.Time
  // and add a combined one for the app
  startDateTime DateTime?

  coverCharge    Decimal? @map("cover_charge") @db.Decimal(6, 2)
  ageRestriction String?  @map("age_restriction") @db.VarChar(50)
  artistText     String?  @map("artist_text") @db.VarChar(200)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // FKs
  venueId         String  @map("venue_id")
  artistId        String? @map("artist_id")
  createdByUserId String  @map("created_by_user_id")

  venue     Venue   @relation(fields: [venueId], references: [id], onDelete: Cascade)
  artist    Artist? @relation(fields: [artistId], references: [id], onDelete: SetNull)
  createdBy User    @relation("EventCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([eventDate])
  @@index([venueId])
  @@index([artistId])
  @@index([isActive])
  @@map("events")
}

// ===== Genre =====
model Genre {
  id          String   @id @default(cuid())
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  artists ArtistGenre[]

  @@map("genres")
}

// ===== ArtistGenre (M2M) =====
model ArtistGenre {
  artistId String @map("artist_id")
  genreId  String @map("genre_id")

  artist Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)
  genre  Genre  @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([artistId, genreId])
  @@map("artist_genres")
}

// ===== Favorites (future) =====
model FavoriteArtist {
  userId    String   @map("user_id")
  artistId  String   @map("artist_id")
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  artist Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)

  @@id([userId, artistId])
  @@map("favorite_artists")
}

model FavoriteVenue {
  userId    String   @map("user_id")
  venueId   String   @map("venue_id")
  createdAt DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@id([userId, venueId])
  @@map("favorite_venues")
}
